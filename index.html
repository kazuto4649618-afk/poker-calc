<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ポーカー収支管理</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: sans-serif; padding:10px; margin:0; }
h2 { text-align:center; }
button { margin:5px 2px; padding:8px; }
input { width:80px; }
table { border-collapse: collapse; width:100%; font-size:14px; }
th, td { border:1px solid #ccc; padding:5px; text-align:center; }
thead { background:#f0f0f0; }
@media(max-width:600px){
  table { font-size:12px; }
  input { width:60px; }
}
.section { margin-top:20px; }
</style>
</head>
<body>

<h2>ポーカー収支管理</h2>

<div>
大会名: <input type="text" id="tournamentName">
日付: <input type="date" id="tournamentDate">
<button onclick="saveTournament()">保存</button>
<button onclick="downloadCSV()">CSV</button>
</div>

<div class="section">
<button onclick="addPlayer()">プレイヤー追加</button>
<button onclick="addRow()">行追加</button>
</div>

<table id="pokerTable">
<thead>
<tr id="playerRow">
<th>項目</th>
<th><input placeholder="Player1"></th>
<th>合計</th>
</tr>
</thead>
<tbody id="bodyRows">
<tr>
<td>1</td>
<td><input type="number" oninput="calculate()"></td>
<td class="rowTotal">0</td>
</tr>
</tbody>
<tfoot>
<tr id="totalRow">
<td>合計</td>
<td class="colTotal">0</td>
<td id="grandTotal">0</td>
</tr>
</tfoot>
</table>

<div class="section">
<h3>大会履歴</h3>
<select id="historySelect" onchange="loadTournament()">
<option value="">選択</option>
</select>
</div>

<div class="section">
<h3>年別プレイヤー収支</h3>
<div id="yearlySummary"></div>
</div>

<script>
function calculate() {
  const table = document.getElementById("pokerTable");
  const rows = table.tBodies[0].rows;
  const colTotals = [];
  let grandTotal = 0;

  for (let i=0;i<rows.length;i++) {
    let rowTotal = 0;
    for (let j=1;j<rows[i].cells.length-1;j++) {
      const val = parseFloat(rows[i].cells[j].children[0]?.value) || 0;
      rowTotal += val;
      colTotals[j-1] = (colTotals[j-1] || 0) + val;
    }
    rows[i].cells[rows[i].cells.length-1].innerText = rowTotal;
  }

  const totalRow = document.getElementById("totalRow");
  for (let i=0;i<colTotals.length;i++) {
    totalRow.cells[i+1].innerText = colTotals[i];
    grandTotal += colTotals[i];
  }
  document.getElementById("grandTotal").innerText = grandTotal;
}

function addPlayer() {
  const headerRow = document.getElementById("playerRow");
  const totalRow = document.getElementById("totalRow");
  const bodyRows = document.getElementById("bodyRows").rows;

  const th = document.createElement("th");
  th.innerHTML = '<input placeholder="Player">';
  headerRow.insertBefore(th, headerRow.lastElementChild);

  for (let row of bodyRows) {
    const td = document.createElement("td");
    td.innerHTML = '<input type="number" oninput="calculate()">';
    row.insertBefore(td, row.lastElementChild);
  }

  const tdTotal = document.createElement("td");
  tdTotal.className="colTotal";
  tdTotal.innerText="0";
  totalRow.insertBefore(tdTotal, totalRow.lastElementChild);
}

function addRow() {
  const body = document.getElementById("bodyRows");
  const newRow = body.insertRow();
  newRow.insertCell().innerText = body.rows.length;
  const playerCount = document.getElementById("playerRow").cells.length-2;

  for(let i=0;i<playerCount;i++){
    const td = newRow.insertCell();
    td.innerHTML='<input type="number" oninput="calculate()">';
  }
  newRow.insertCell().className="rowTotal";
}

function saveTournament() {
  const name = document.getElementById("tournamentName").value;
  const date = document.getElementById("tournamentDate").value;
  if(!name || !date) return alert("大会名と日付を入力");

  const data = getCurrentData();
  const history = JSON.parse(localStorage.getItem("pokerHistory")||"{}");
  history[name+"_"+date]=data;
  localStorage.setItem("pokerHistory",JSON.stringify(history));
  loadHistoryList();
  updateYearlySummary();
  alert("保存しました");
}

function getCurrentData(){
  const table = document.getElementById("pokerTable");
  const players = [];
  const headerCells = table.tHead.rows[0].cells;
  for(let i=1;i<headerCells.length-1;i++){
    players.push(headerCells[i].children[0].value||"Player");
  }

  const totals = [];
  const totalRow = document.getElementById("totalRow").cells;
  for(let i=1;i<totalRow.length-1;i++){
    totals.push(parseFloat(totalRow[i].innerText)||0);
  }

  return {
    name: document.getElementById("tournamentName").value,
    date: document.getElementById("tournamentDate").value,
    players: players,
    totals: totals
  };
}

function loadHistoryList(){
  const select=document.getElementById("historySelect");
  select.innerHTML='<option value="">選択</option>';
  const history=JSON.parse(localStorage.getItem("pokerHistory")||"{}");
  for(let key in history){
    select.innerHTML+=`<option value="${key}">${key}</option>`;
  }
}

function loadTournament(){
  const key=document.getElementById("historySelect").value;
  if(!key) return;
  const history=JSON.parse(localStorage.getItem("pokerHistory")||"{}");
  alert("保存済データ:\n"+JSON.stringify(history[key],null,2));
}

function updateYearlySummary(){
  const history=JSON.parse(localStorage.getItem("pokerHistory")||"{}");
  const yearly={};

  for(let key in history){
    const data=history[key];
    const year=data.date.substring(0,4);
    if(!yearly[year]) yearly[year]={};

    data.players.forEach((p,i)=>{
      yearly[year][p]=(yearly[year][p]||0)+data.totals[i];
    });
  }

  let html="";
  for(let year in yearly){
    html+=`<h4>${year}年</h4><ul>`;
    for(let p in yearly[year]){
      html+=`<li>${p}: ${yearly[year][p]}</li>`;
    }
    html+="</ul>";
  }

  document.getElementById("yearlySummary").innerHTML=html;
}

function downloadCSV(){
  const data=getCurrentData();
  let csv="Player,Total\n";
  data.players.forEach((p,i)=>{
    csv+=`${p},${data.totals[i]}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="poker.csv";
  a.click();
}

loadHistoryList();
updateYearlySummary();
</script>

</body>
</html>
